<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout">
<head lang="en">
<title>Hello twitter</title>
<script src="/webjars/sockjs-client/1.0.0/sockjs.js"></script>
<script src="/webjars/stomp-websocket/2.3.3/stomp.js"></script>
<script> 
	var currentLocation = window.location.href;
	var search = currentLocation.substr(currentLocation.lastIndexOf('=') + 1);
	
	connect();
	
	function connect() {
		
		var socket = new SockJS('/twitterSearch');
		stompClient = Stomp.over(socket);
		
		// stompClient.debug = null;
		stompClient.connect({}, function (frame) {
			console.log('Connected: ' + frame);
			stompClient.subscribe('/topic/searchResults', function (result)	{
					displayTweets(JSON.parse(result.body));
			});
			
			stompClient.send("/app/search", {}, JSON.stringify(search.split(',')));
		});
	}
	
	function displayTweets(tweets) {
				
		$.each(tweets, function (index, tweet) {
			addTweet(tweet);
		})
	}
	
	function addTweet(tweet) {
		
		var template = '<li class="collection-item avatar">' +
		'<span class="title">' + tweet.user + '</span>' +
		'<p>' + tweet.text + '</p>' +
		'</li>';
		
		$('#tweets').append(template);
	}
</script>
</head>
<body>

<div class="row" layout:fragment="content">
<h2 class="indigo-text center" th:text="|Tweet results for ${search}|">Tweets</h2>
<ul id="tweets" class="collection">
</ul>
</div>
</body>
</html>